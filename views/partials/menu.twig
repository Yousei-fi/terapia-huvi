{% set lang = language ?? 'fi' %}
{% set language_options = languages ?? [] %}
{% set navigation_defaults = {
  'cta_label': {
    'fi': 'Varaa aika',
    'en': 'Book appointment'
  },
  'cta_url': {
    'fi': '#',
    'en': '#'
  },
  'toggle_label': {
    'fi': 'Avaa valikko',
    'en': 'Open menu'
  },
  'links': {
    'fi': [
      { 'title': 'Terapia', 'copy': '/terapia' },
      { 'title': 'Minusta', 'copy': '/minusta' },
      { 'title': 'Yhteystiedot', 'copy': '/yhteystiedot' },
      { 'title': 'Tietosuoja', 'copy': '/tietosuoja' }
    ],
    'en': [
      { 'title': 'Therapy', 'copy': '/terapia?lang=en' },
      { 'title': 'About me', 'copy': '/minusta?lang=en' },
      { 'title': 'Contact', 'copy': '/yhteystiedot?lang=en' },
      { 'title': 'Privacy', 'copy': '/tietosuoja?lang=en' }
    ]
  }
} %}

{% set nav_links = [] %}
{% if menu and menu.items %}
  {% for item in menu.items %}
    {% set nav_links = nav_links|merge([{
      'title': item.title,
      'url': item.link
    }]) %}
  {% endfor %}
{% else %}
  {% set fallback_pairs = page_field_pairs('site-navigation', 'links_' ~ lang, navigation_defaults.links[lang] ?? navigation_defaults.links.fi) %}
  {% for pair in fallback_pairs %}
    {% set nav_links = nav_links|merge([{
      'title': pair.title,
      'url': pair.copy
    }]) %}
  {% endfor %}
{% endif %}

{% set cta_label_default = navigation_defaults.cta_label[lang] ?? navigation_defaults.cta_label.fi %}
{% set cta_url_default = navigation_defaults.cta_url[lang] ?? navigation_defaults.cta_url.fi %}
{% set cta_url = page_field('site-navigation', 'cta_url_' ~ lang, cta_url_default) %}
{% set cta_label = page_field('site-navigation', 'cta_label_' ~ lang, cta_label_default) %}
{% set toggle_label = page_field('site-navigation', 'toggle_label_' ~ lang, navigation_defaults.toggle_label[lang] ?? navigation_defaults.toggle_label.fi) %}

{% macro link_url(value) %}
  {% if value is empty %}
    {{ '#' }}
  {% elseif value starts with 'http' %}
    {{ value }}
  {% else %}
    {{ function('home_url', value) }}
  {% endif %}
{% endmacro %}
{% import _self as menu_helpers %}

<nav class="bg-brand-charcoal text-white shadow-soft">
  <div class="mx-auto flex max-w-6xl items-center justify-between px-4 py-3 md:py-4">
    <a href="{{ site.url }}" class="flex items-center gap-3 text-base font-semibold tracking-tight">
      <img src="{{ site.theme.link }}/logo.svg" alt="TerapiaHuvi logo" class="h-10 w-10 rounded-full border border-white/40 bg-white/80 object-cover shadow-soft">
      <span class="hidden sm:inline">{{ site.name }}</span>
    </a>
    <div class="flex items-center gap-3 md:gap-6">
      {% if nav_links %}
        <div class="hidden items-center gap-6 text-sm font-medium md:flex">
          {% for item in nav_links %}
            <a href="{{ menu_helpers.link_url(item.url|default('#')) }}" class="transition text-white/85 hover:text-brand-wood">{{ item.title }}</a>
          {% endfor %}
        </div>
      {% endif %}
      <button class="inline-flex h-10 w-10 items-center justify-center rounded-full border border-white/30 bg-white/10 text-white transition hover:bg-white/20 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-white/60 md:hidden" type="button" data-nav-toggle aria-expanded="false" aria-controls="primary-navigation">
        <span class="sr-only">{{ toggle_label }}</span>
        <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
          <path d="M4 6h16M4 12h16M4 18h16" />
        </svg>
      </button>
      <a href="{{ menu_helpers.link_url(cta_url) }}" class="btn-primary hidden md:inline-flex">{{ cta_label }}</a>
      <div class="hidden items-center gap-2 text-xs font-semibold uppercase tracking-wide text-white/80 md:flex">
        {% for option in language_options %}
          <a href="{{ option.url }}" class="rounded-full border border-white/25 bg-white/5 px-3 py-1 transition hover:bg-white/15 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-white/60 {{ option.current ? 'text-brand-charcoal bg-white' : 'text-white' }}">{{ option.code|upper }}</a>
        {% endfor %}
      </div>
    </div>
  </div>
  <div class="hidden border-t border-white/10 bg-brand-charcoal/95 backdrop-blur md:hidden" id="primary-navigation" data-nav-panel>
    <div class="mx-auto flex max-w-6xl flex-col gap-1 px-4 py-4 text-base font-medium">
      {% if nav_links %}
        {% for item in nav_links %}
          <a href="{{ menu_helpers.link_url(item.url|default('#')) }}" class="rounded-full px-4 py-2 text-white/90 transition hover:bg-white/10 hover:text-white">{{ item.title }}</a>
        {% endfor %}
      {% endif %}
      <a href="{{ menu_helpers.link_url(cta_url) }}" class="btn-primary mt-3">{{ cta_label }}</a>
      <div class="flex items-center gap-2 px-4 py-3">
        {% for option in language_options %}
          <a href="{{ option.url }}" class="rounded-full border border-white/25 bg-white/5 px-3 py-1 text-xs font-semibold uppercase tracking-wide transition hover:bg-white/15 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-white/60 {{ option.current ? 'text-brand-charcoal bg-white' : 'text-white' }}">{{ option.code|upper }}</a>
        {% endfor %}
      </div>
    </div>
  </div>
</nav>

