{% set lang = language ?? 'fi' %}
{% set language_options = languages ?? [] %}
{% set navigation_defaults = {
  'links': {
    'fi': [
      { 'title': 'Etusivu', 'url': '/' },
      { 'title': 'Terapia', 'url': '/terapia' },
      { 'title': 'Hinnasto', 'url': '/hinnasto' },
      { 'title': 'Minusta', 'url': '/minusta' },
      { 'title': 'Yhteystiedot', 'url': '/yhteystiedot' },
      { 'title': 'Lahjakortit', 'url': '/lahjakortit' }
    ],
    'en': [
      { 'title': 'Home', 'url': '/' },
      { 'title': 'Therapy', 'url': '/terapia?lang=en' },
      { 'title': 'Pricing', 'url': '/hinnasto?lang=en' },
      { 'title': 'About me', 'url': '/minusta?lang=en' },
      { 'title': 'Contact', 'url': '/yhteystiedot?lang=en' },
      { 'title': 'Gift cards', 'url': '/lahjakortit?lang=en' }
    ]
  },
  'cta_label': {
    'fi': 'Varaa aika',
    'en': 'Book appointment'
  },
  'cta_url': {
    'fi': '#',
    'en': '#'
  }
} %}

{% set nav_links = [] %}
{% if menu and menu.items %}
  {% for item in menu.items %}
    {% set nav_links = nav_links|merge([{
      'title': item.title,
      'url': item.link
    }]) %}
  {% endfor %}
{% else %}
  {% set fallback_pairs = page_field_pairs('site-navigation', 'links_' ~ lang, navigation_defaults.links[lang] ?? navigation_defaults.links.fi) %}
  {% for pair in fallback_pairs %}
    {% set nav_links = nav_links|merge([{
      'title': pair.title,
      'url': pair.copy
    }]) %}
  {% endfor %}
{% endif %}

{% set cta_label_default = navigation_defaults.cta_label[lang] ?? navigation_defaults.cta_label.fi %}
{% set cta_url_default = navigation_defaults.cta_url[lang] ?? navigation_defaults.cta_url.fi %}
{% set cta_url = page_field('site-navigation', 'cta_url_' ~ lang, cta_url_default) %}
{% set cta_label = page_field('site-navigation', 'cta_label_' ~ lang, cta_label_default) %}

{% macro link_url(value) %}
  {% if value is empty %}
    {{ '#' }}
  {% elseif value starts with 'http' %}
    {{ value }}
  {% else %}
    {{ function('home_url', value) }}
  {% endif %}
{% endmacro %}
{% import _self as header_helpers %}

<header class="relative overflow-hidden" style="background-color: #A47551;">
  <div class="leaves-container absolute inset-0 overflow-hidden pointer-events-none"></div>
  <div class="relative mx-auto max-w-6xl px-4 py-4 md:py-5">
    <div class="flex items-center justify-between gap-4">
      <div class="hidden md:flex items-center gap-4 md:gap-6 text-sm font-medium">
        {% if nav_links %}
          {% set left_links = nav_links|slice(0, (nav_links|length / 2)|round) %}
          {% for item in left_links %}
            <a href="{{ header_helpers.link_url(item.url|default('#')) }}" class="text-[#F8F5F1] transition hover:text-white/80">{{ item.title }}</a>
          {% endfor %}
        {% endif %}
      </div>
      <button class="md:hidden inline-flex h-10 w-10 items-center justify-center rounded-full border border-[#F8F5F1]/30 bg-[#F8F5F1]/10 text-[#F8F5F1] transition hover:bg-[#F8F5F1]/20 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-[#F8F5F1]/60" type="button" data-nav-toggle aria-expanded="false" aria-controls="primary-navigation">
        <span class="sr-only">Avaa valikko</span>
        <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
          <path d="M4 6h16M4 12h16M4 18h16" />
        </svg>
      </button>
      <a href="{{ site.url }}" class="text-2xl font-serif font-semibold tracking-tight text-[#F8F5F1] md:text-3xl hover:text-white transition">Valtteri Huvi</a>
      <div class="hidden md:flex items-center gap-4 md:gap-6 text-sm font-medium">
        {% if nav_links %}
          {% set right_links = nav_links|slice((nav_links|length / 2)|round) %}
          {% for item in right_links %}
            <a href="{{ header_helpers.link_url(item.url|default('#')) }}" class="text-[#F8F5F1] transition hover:text-white/80">{{ item.title }}</a>
          {% endfor %}
        {% endif %}
        <a href="{{ header_helpers.link_url(cta_url) }}" class="inline-flex items-center justify-center gap-2 rounded-full border border-[#F8F5F1]/30 bg-[#F8F5F1]/10 px-4 py-2 text-sm font-semibold text-[#F8F5F1] backdrop-blur transition hover:bg-[#F8F5F1]/20">{{ cta_label }}</a>
        {% if language_options %}
          <div class="items-center gap-2 text-xs font-semibold uppercase tracking-wide hidden md:flex">
            {% for option in language_options %}
              <a href="{{ option.url }}" class="rounded-full border border-[#F8F5F1]/25 bg-[#F8F5F1]/5 px-3 py-1 transition hover:bg-[#F8F5F1]/15 {{ option.current ? 'text-[#A47551] bg-[#F8F5F1]' : 'text-[#F8F5F1]' }}">{{ option.code|upper }}</a>
            {% endfor %}
          </div>
        {% endif %}
      </div>
    </div>
    <div class="hidden border-t border-[#F8F5F1]/10 mt-4 pt-4 md:hidden" id="primary-navigation" data-nav-panel>
      <div class="flex flex-col gap-2 text-base font-medium">
        {% if nav_links %}
          {% for item in nav_links %}
            <a href="{{ header_helpers.link_url(item.url|default('#')) }}" class="rounded-full px-4 py-2 text-[#F8F5F1]/90 transition hover:bg-[#F8F5F1]/10 hover:text-white">{{ item.title }}</a>
          {% endfor %}
        {% endif %}
        <a href="{{ header_helpers.link_url(cta_url) }}" class="mt-2 inline-flex items-center justify-center gap-2 rounded-full border border-[#F8F5F1]/30 bg-[#F8F5F1]/10 px-4 py-2 text-sm font-semibold text-[#F8F5F1] backdrop-blur transition hover:bg-[#F8F5F1]/20">{{ cta_label }}</a>
        {% if language_options %}
          <div class="flex items-center gap-2 px-4 py-3">
            {% for option in language_options %}
              <a href="{{ option.url }}" class="rounded-full border border-[#F8F5F1]/25 bg-[#F8F5F1]/5 px-3 py-1 text-xs font-semibold uppercase tracking-wide transition hover:bg-[#F8F5F1]/15 {{ option.current ? 'text-[#A47551] bg-[#F8F5F1]' : 'text-[#F8F5F1]' }}">{{ option.code|upper }}</a>
            {% endfor %}
          </div>
        {% endif %}
      </div>
    </div>
  </div>
  <style>
    .leaves-container {
      position: absolute;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      overflow: hidden;
    }
    .leaf {
      position: absolute;
      top: -5vh;
      width: 20px;
      height: 12px;
      background: #A47551;
      border-radius: 50% 0 50% 0;
      opacity: 0.8;
      transform: rotate(45deg);
      animation: fall linear infinite;
      pointer-events: none;
    }
    @keyframes fall {
      0% {
        transform: translateX(0) translateY(0) rotate(0deg);
      }
      100% {
        transform: translateX(200px) translateY(110vh) rotate(720deg);
      }
    }
  </style>
  <script>
    (function() {
      function initLeaves() {
        const container = document.querySelector('.leaves-container');
        if (!container) return;
        
        const colors = ['#A47551', '#708D81', '#9FBCC1', '#B08968'];
        
        for (let i = 0; i < 15; i++) {
          const leaf = document.createElement('div');
          leaf.classList.add('leaf');
          leaf.style.left = Math.random() * 100 + '%';
          leaf.style.animationDuration = (5 + Math.random() * 5) + 's';
          leaf.style.animationDelay = Math.random() * 5 + 's';
          leaf.style.background = colors[Math.floor(Math.random() * colors.length)];
          container.appendChild(leaf);
        }
      }
      
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initLeaves);
      } else {
        initLeaves();
      }
    })();
  </script>
</header>

